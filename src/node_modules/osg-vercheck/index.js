var log;
exports.log = log = require('osg-logger').of("version-checker");
exports.route = route;
exports.vercheck = vercheck;
exports.version = "/*Restarting ... Try again*/";

//assure version file on startup
require("fs").readFile( "./v", function(err,f){ 
    if (err){
        log.fatal("cannot find version info", err);
        process.exit(1);
    }

    log.info("Version data found : %s", exports.version = f+"");
});
log.debug("module loaded");

function route(app){ 
    /**
     * Version checker - CDN
     */
    app.get('/v/:ver/v', vercheck);
    /**
     * Version checker - direct
     */
    app.get('/v'       , vercheck);

    log.info("routed");
}

function vercheck(req,res) { 
    res.setHeader('Content-Type', 'text/javascript');
    res.setHeader('Content-Length', Buffer.byteLength(exports.version, 'utf8'));
    res.writeHead(200,"OK");
    res.end(exports.version);
}

